# GPX Generator API Reference

The `gpx_generator` module provides functionality for generating GPX files from GPS data.

## GPXGenerator Class

```python
class GPXGenerator:
    """Class for generating GPX files from GPS data."""
```

This class is responsible for creating GPX files from the GPS data extracted from images.

### Methods

#### `create_gpx(gps_data_list, output_path)`

Create a GPX file from a list of GPS data points.

```python
@staticmethod
def create_gpx(gps_data_list, output_path):
    """
    Create a GPX file from a list of GPS data points.
    
    Args:
        gps_data_list: List of dictionaries containing GPS data
                       (latitude, longitude, altitude, timestamp, name)
        output_path: Path where the GPX file will be saved
        
    Returns:
        bool: True if the GPX file was created successfully, False otherwise
    """
```

Example:
```python
from pixtrail.gpx_generator import GPXGenerator

# GPS data points
gps_data = [
    {
        "latitude": 35.0394,
        "longitude": 135.7292,
        "altitude": 100.0,
        "timestamp": datetime(2023, 1, 1, 12, 0, 0),
        "name": "photo1.jpg"
    },
    {
        "latitude": 35.6812,
        "longitude": 139.7671,
        "altitude": 200.0,
        "timestamp": datetime(2023, 1, 2, 12, 0, 0),
        "name": "photo2.jpg"
    }
]

# Generate GPX file
success = GPXGenerator.create_gpx(gps_data, "/path/to/output.gpx")

if success:
    print("GPX file created successfully")
else:
    print("Failed to create GPX file")
```

#### `add_waypoint_to_gpx(gpx_file, latitude, longitude, name=None, altitude=None, timestamp=None)`

Add a waypoint to an existing GPX file. If the file doesn't exist, create it.

```python
@staticmethod
def add_waypoint_to_gpx(gpx_file, latitude, longitude, name=None, altitude=None, timestamp=None):
    """
    Add a waypoint to an existing GPX file. If the file doesn't exist, create it.
    
    Args:
        gpx_file: Path to the GPX file
        latitude: Waypoint latitude
        longitude: Waypoint longitude
        name: Waypoint name
        altitude: Waypoint altitude
        timestamp: Waypoint timestamp
        
    Returns:
        bool: True if the waypoint was added successfully, False otherwise
    """
```

Example:
```python
from pixtrail.gpx_generator import GPXGenerator
from datetime import datetime

# Add a single waypoint to a GPX file
success = GPXGenerator.add_waypoint_to_gpx(
    "/path/to/output.gpx",
    35.0394,
    135.7292,
    name="Kinkaku-ji",
    altitude=100.0,
    timestamp=datetime.now()
)

if success:
    print("Waypoint added successfully")
else:
    print("Failed to add waypoint")
```

## GPX File Structure

The GPX files generated by PixTrail include:

1. **Metadata**: Basic information about the GPX file
2. **Waypoints**: Individual points representing each photo
3. **Track**: A continuous path connecting all the waypoints in chronological order

Example of a generated GPX file:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<gpx xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="PixTrail - GPS Photo Tracker">
  <wpt lat="35.0394" lon="135.7292">
    <ele>100.0</ele>
    <time>2023-01-01T12:00:00Z</time>
    <name>photo1.jpg</name>
  </wpt>
  <wpt lat="35.6812" lon="139.7671">
    <ele>200.0</ele>
    <time>2023-01-02T12:00:00Z</time>
    <name>photo2.jpg</name>
  </wpt>
  <trk>
    <trkseg>
      <trkpt lat="35.0394" lon="135.7292">
        <ele>100.0</ele>
        <time>2023-01-01T12:00:00Z</time>
      </trkpt>
      <trkpt lat="35.6812" lon="139.7671">
        <ele>200.0</ele>
        <time>2023-01-02T12:00:00Z</time>
      </trkpt>
    </trkseg>
  </trk>
</gpx>
```

## How the GPX Generator Works

The GPXGenerator uses the `gpxpy` library to create and manipulate GPX files. The process is as follows:

1. A new GPX object is created (or an existing one is loaded)
2. Waypoints are added for each GPS data point
3. A track is created with a single segment
4. Track points are added to the segment, corresponding to each GPS data point
5. The GPX file is written to the specified output path

The generated GPX file is compatible with most GPS and mapping applications, including:
- Google Earth
- OpenStreetMap
- Garmin GPS devices
- Strava
- Other GPS tracking applications

## Error Handling

The GPXGenerator includes error handling for various scenarios:

- If the GPS data list is empty, the function returns `False`
- If there is an error creating the output directory, an error message is printed
- If there is an error writing the GPX file, an error message is printed
- Any other exceptions are caught and logged

## Advanced Usage Examples

### Creating a GPX File with Custom Metadata

```python
import gpxpy
import gpxpy.gpx
from pixtrail.gpx_generator import GPXGenerator

# Create a custom GPX file with metadata
def create_custom_gpx(gps_data_list, output_path, name=None, description=None):
    # Create a new GPX object
    gpx = gpxpy.gpx.GPX()
    
    # Set the creator
    gpx.creator = "PixTrail - Custom GPX Creator"
    
    # Add metadata
    if name or description:
        gpx.name = name
        gpx.description = description
    
    # Add waypoints and track
    for point in gps_data_list:
        # Create waypoint
        waypoint = gpxpy.gpx.GPXWaypoint(
            latitude=point['latitude'],
            longitude=point['longitude'],
            elevation=point.get('altitude', 0),
            time=point.get('timestamp'),
            name=point.get('name', 'Unknown')
        )
        gpx.waypoints.append(waypoint)
    
    # Create a track
    track = gpxpy.gpx.GPXTrack()
    gpx.tracks.append(track)
    
    # Create a segment
    segment = gpxpy.gpx.GPXTrackSegment()
    track.segments.append(segment)
    
    # Add track points
    for point in gps_data_list:
        track_point = gpxpy.gpx.GPXTrackPoint(
            latitude=point['latitude'],
            longitude=point['longitude'],
            elevation=point.get('altitude', 0),
            time=point.get('timestamp')
        )
        segment.points.append(track_point)
    
    # Write to file
    try:
        with open(output_path, 'w') as f:
            f.write(gpx.to_xml())
        return True
    except Exception as e:
        print(f"Error creating GPX file: {e}")
        return False

# Use the custom function
success = create_custom_gpx(
    gps_data_list,
    "/path/to/custom.gpx",
    name="My Journey",
    description="Photos from my vacation"
)
```

### Creating Multiple GPX Files from Filtered Data

```python
from pixtrail.exif_reader import ExifReader
from pixtrail.gpx_generator import GPXGenerator
import os
from datetime import datetime

def process_by_date(directory, output_dir):
    """Process photos and create separate GPX files by date."""
    # Get all image files
    image_files = [
        os.path.join(directory, f) 
        for f in os.listdir(directory) 
        if f.lower().endswith(('.jpg', '.jpeg', '.tiff', '.png'))
    ]
    
    # Extract GPS data
    gps_data_list = []
    for image_file in image_files:
        gps_data = ExifReader.extract_gps_data(image_file)
        if gps_data:
            gps_data_list.append(gps_data)
    
    # Group by date
    data_by_date = {}
    for point in gps_data_list:
        if 'timestamp' in point:
            date_str = point['timestamp'].strftime('%Y-%m-%d')
            if date_str not in data_by_date:
                data_by_date[date_str] = []
            data_by_date[date_str].append(point)
    
    # Create GPX files for each date
    results = {}
    for date_str, data in data_by_date.items():
        output_path = os.path.join(output_dir, f"{date_str}.gpx")
        success = GPXGenerator.create_gpx(data, output_path)
        results[date_str] = success
    
    return results

# Process photos and create GPX files by date
results = process_by_date("/path/to/photos", "/path/to/output")

# Print results
for date, success in results.items():
    print(f"{date}: {'Success' if success else 'Failed'}")
```

## Limitations

- The GPX file format has some limitations, such as not supporting image embedding
- Large numbers of waypoints can make the GPX file large and potentially slow to load in some applications
- Some GPX viewers might not support all features (like elevation or timestamps)